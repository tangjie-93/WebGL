<!DOCTYPE html>
<html>

<head>
    <title>WebGL Skybox</title>
    <style>
        @import url("https://webglfundamentals.org/webgl/resources/webgl-tutorials.css");

        body {
            margin: 0;
        }

        canvas {
            width: 500px;
            height: 500px;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script id="vertex-shader-skybox" type="x-shader/x-vertex">
        attribute vec4 a_position;
        varying vec3 v_texCoord;
        
        void main() {
          v_texCoord = a_position.xyz;
          gl_Position = a_position;
        }
    </script>
    <script id="fragment-shader-skybox" type="x-shader/x-fragment">
        precision mediump float;
        
        uniform samplerCube u_skybox;
        varying vec3 v_texCoord;
        
        void main() {
          gl_FragColor = textureCube(u_skybox, normalize(v_texCoord));
        }
        </script>


    <script>
        function createShader(gl, type, source) {
            var shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }

        function createProgram(gl, vertexShader, fragmentShader) {
            var program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                console.error(gl.getProgramInfoLog(program));
                gl.deleteProgram(program);
                return null;
            }
            return program;
        }

        var canvas = document.getElementById("canvas");
        var gl = canvas.getContext("webgl");
        if (!gl) {
            console.error("WebGL not supported");
        }

        var vertexShaderSource = document.getElementById("vertex-shader-skybox").text;
        var fragmentShaderSource = document.getElementById("fragment-shader-skybox").text;

        var vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
        var fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);

        var program = createProgram(gl, vertexShader, fragmentShader);

        var positionLocation = gl.getAttribLocation(program, "a_position");

        var skyboxLocation = gl.getUniformLocation(program, "u_skybox");

        var positions = new Float32Array([
            -1, -1, 1,
            1, -1, 1,
            -1, 1, 1,
            -1, 1, 1,
            1, -1, 1,
            1, 1, 1,

            -1, -1, -1,
            -1, 1, -1,
            1, -1, -1,
            -1, 1, -1,
            1, 1, -1,
            1, -1, -1,

            -1, 1, -1,
            -1, 1, 1,
            1, 1, -1,
            -1, 1, 1,
            1, 1, 1,
            1, 1, -1,

            -1, -1, -1,
            1, -1, -1,
            -1, -1, 1,
            -1, -1, 1,
            1, -1, -1,
            1, -1, 1,

            -1, -1, -1,
            -1, -1, 1,
            -1, 1, -1,
            -1, -1, 1,
            -1, 1, 1,
            -1, 1, -1,

            1, -1, -1,
            1, 1, -1,
            1, -1, 1,
            1, -1, 1,
            1, 1, -1,
            1, 1, 1,
        ]);

        var positionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);

        var texture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_CUBE_MAP, texture);

        const faceInfos = [
            {
                target: gl.TEXTURE_CUBE_MAP_POSITIVE_X,
                url: '../../images/pos-x.jpg',
            },
            {
                target: gl.TEXTURE_CUBE_MAP_NEGATIVE_X,
                url: '../../images/neg-x.jpg',
            },
            {
                target: gl.TEXTURE_CUBE_MAP_POSITIVE_Y,
                url: '../../images/pos-y.jpg',
            },
            {
                target: gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,
                url: '../../images/neg-y.jpg',
            },
            {
                target: gl.TEXTURE_CUBE_MAP_POSITIVE_Z,
                url: '../../images/pos-z.jpg',
            },
            {
                target: gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,
                url: '../../images/neg-z.jpg',
            },
        ];

        faceInfos.forEach((faceInfo) => {
            const { target, url } = faceInfo;

            const level = 0;
            const internalFormat = gl.RGBA;
            const width = 512;
            const height = 512;
            const format = gl.RGBA;
            const type = gl.UNSIGNED_BYTE;

            gl.texImage2D(target, level, internalFormat, width, height, 0, format, type, null);

            const image = new Image();
            image.src = url;
            image.onload = () => {
                gl.bindTexture(gl.TEXTURE_CUBE_MAP, texture);
                gl.texImage2D(target, level, internalFormat, format, type, image);
                gl.generateMipmap(gl.TEXTURE_CUBE_MAP);
            };
        });

        gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);
        gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

        function render() {
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            gl.useProgram(program);

            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 3, gl.FLOAT, false, 0, 0);

            gl.uniform1i(skyboxLocation, 0);

            gl.drawArrays(gl.TRIANGLES, 0, 36);

            requestAnimationFrame(render);
        }

        render();
    </script>
</body>

</html>