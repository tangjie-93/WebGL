<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>纹理贴图</title>
</head>

<body>
    <canvas id="canvas" width="400" height="400"></canvas>
    <script type="shader-source" id="vertexShader">
      //浮点数设置为中等精度
      precision mediump float;
      attribute vec2 a_Position;
      uniform vec2 u_Screen_Size;
      varying vec2 v_Uv;
      attribute vec2 a_Uv;
      uniform mat4 mx;
      uniform mat4 my;
      void main(){
          //vec2类型的数据可以直接乘除
          //position的坐标值在(-1,-1)到(1,1)之间
          vec2 position = (a_Position / u_Screen_Size) * 2.0 - 1.0;
          position = position * vec2(1.0, -1.0);
          gl_Position = mx*my*vec4(position, 0, 1);
          //纹理坐标差值计算
          v_Uv = a_Uv;
      }
    </script>
    <script type="shader-source" id="fragmentShader">
      //浮点数设置为中等精度
      precision mediump float;
      uniform sampler2D u_Texture;
      varying vec2 v_Uv;
      void main(){
          vec4 texture=texture2D(u_Texture, v_Uv);
        //计算RGB三个分量光能量之和，也就是亮度
        float luminance = 0.199*texture.r+0.187*texture.g+0.714*texture.b;
        //逐片元赋值，RGB相同均为亮度值，用黑白两色表达图片的明暗变化
        gl_FragColor = vec4(luminance,luminance,luminance,1.0); 
      }
    </script>
    <script src="../utils/webgl-helper.js"></script>
    <script src="../utils/vector3.js"></script>
    <script src="../utils/webgl-matrix.js"></script>
    <script>
        //获取canvas
        let canvas = document.querySelector("#canvas");
        //获取绘图上下文
        let gl = canvas.getContext('webgl');
        gl.viewport(0, 0, canvas.clientWidth, canvas.clientHeight);
        //创建着色器程序
        let program = createSimpleProgramFromScript(
            gl,
            "vertexShader",
            "fragmentShader"
        );

        //使用该着色器程序
        gl.useProgram(program);
        let positions = new Float32Array([
            30, 30, 0, 0,
            30, 370, 0, 1,
            370, 370, 1, 1,
            30, 30, 0, 0,
            370, 370, 1, 1,
            370, 30, 1, 0
        ]);

        // 随机生成一个颜色。
        const color = randomColor();
        // 找到着色器中的全局变量 u_Color;
        const u_Texture = gl.getUniformLocation(program, "u_Texture");
        const u_Screen_Size = gl.getUniformLocation(program, "u_Screen_Size");
        gl.uniform2f(u_Screen_Size, canvas.width, canvas.height);
        const a_Position = gl.getAttribLocation(program, "a_Position");
        const a_Uv = gl.getAttribLocation(program, "a_Uv");
        const mx = gl.getUniformLocation(program, 'mx');
        const my = gl.getUniformLocation(program, 'my');

        gl.enableVertexAttribArray(a_Position);
        gl.enableVertexAttribArray(a_Uv);
        // 创建缓冲区
        const buffer = gl.createBuffer();
        // 绑定缓冲区为当前缓冲
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        // 设置 a_Position 属性从缓冲区读取数据方式
        gl.vertexAttribPointer(a_Position, 2, gl.FLOAT, false, 16, 0);
        // 设置 a_Uv 属性从缓冲区读取数据方式
        gl.vertexAttribPointer(a_Uv, 2, gl.FLOAT, false, 16, 8);
        // 向缓冲区传递数据
        gl.bufferData(
            gl.ARRAY_BUFFER,
            positions,
            gl.STATIC_DRAW
        );

        function render() {
            tranlate();
            //设置清屏颜色为黑色。
            gl.clearColor(0, 0, 0, 1);
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.drawArrays(gl.TRIANGLES, 0, positions.length / 4);

        }
        function tranlate() {
            const angle=30.0;
            const rad = angle * Math.PI / 180;
            const cos = Math.cos(rad);
            const sin = Math.sin(rad);

            const mx = gl.getUniformLocation(program, 'mx');
            const mxArr = new Float32Array([
                1, 0, 0, 0, 0, cos, -sin, 0, 0, sin, cos, 0, 0, 0, 0, 1
            ])
            gl.uniformMatrix4fv(mx, false, mxArr);

            const my = gl.getUniformLocation(program, 'my');
            const myArr = new Float32Array([
                cos, 0, -sin, 0,  0, 1, 0, 0,  sin, 0, cos, 0,  0, 0, 0, 1
            ])
            
            gl.uniformMatrix4fv(my, false, myArr);
        }
        loadTexture(gl, '../images/1.jpg', u_Texture, function () {
            render();
        })
    </script>
</body>

</html>